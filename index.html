<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket METAR Pro - Instructor Edition v3.9</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --dim: #94a3b8; --green: #4ade80; --red: #fb7185; --warn: #facc15; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 650px; margin: 0 auto; }
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; font-weight: bold; }
        .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .label-sm { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; display: block; }
        .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.85rem; line-height: 1.4; background: #000; padding: 12px; border-radius: 6px; border-left: 4px solid var(--green); margin-top: 8px; white-space: pre-wrap; word-break: break-all; min-height: 40px; }
        .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
        .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-radius: 3px; transition: transform 0.6s ease; }
        .rwy-num { color: white; font-size: 11px; font-weight: bold; font-family: monospace; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; transition: transform 0.6s ease; }
        .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; transition: transform 0.8s ease; }
        #map { height: 260px; border-radius: 12px; margin-top: 10px; background: #111; border: 1px solid #444; }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-group input { flex: 1; padding: 12px; background: #334155; color: white; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
        .input-group button { padding: 0 20px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        select, .tas-input { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .nav-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
        .nav-table th, .nav-table td { padding: 10px 5px; border-bottom: 1px solid #334151; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .info-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border-left: 3px solid #475569; }
    </style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(1)">Ê©üÂ†¥Ë≥áË®ä</button>
        <button class="tab-btn" onclick="switchTab(2)">Ëà™Á∑öË®àÁÆó</button>
    </div>
    <div id="tab1" class="tab-content active">
        <div class="card">
            <span class="label-sm">ICAO ÊâãÂãïËº∏ÂÖ• / ÈÅ∏Âèñ</span>
            <div class="input-group">
                <input type="text" id="icaoInput" placeholder="‰æãÂ¶Ç: RCPO" maxlength="4">
                <button onclick="manualUpdate()">Êü•Ë©¢</button>
            </div>
            <select id="apSelect" onchange="document.getElementById('icaoInput').value=this.value; update()"></select>
        </div>
        <div class="card"><span class="label-sm">ÂéüÂßãÈõªÁ¢º RAW DATA</span><div id="rawView" class="raw-text">Ê∫ñÂÇôÂ∞±Á∑í„ÄÇ</div></div>
        <div id="map"></div>
        <div class="card">
            <span class="label-sm">ÈáçÈªûËß£Ë≠Ø DECODER</span>
            <div class="info-grid">
                <div class="info-item"><span class="label-sm" style="margin:0">ËÉΩË¶ãÂ∫¶ VIS</span><div id="visVal" style="font-weight:bold; font-size:1.1rem">--</div></div>
                <div class="info-item"><span class="label-sm" style="margin:0">Ê∞£Â£ì QNH</span><div id="qnhVal" style="font-weight:bold; font-size:1.1rem">--</div></div>
            </div>
            <div id="rmkBox" style="margin-top:10px; font-size:0.85rem; color:var(--accent); white-space: pre-line; min-height: 20px;"></div>
        </div>
        <button onclick="transfer()" style="width:100%; padding:18px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin: 10px 0 30px 0;">ÂÇ≥ÈÄÅËá≥Ë®àÁÆóÈ†ÅÈù¢ ‚ûî</button>
    </div>
    <div id="tab2" class="tab-content">
        <div class="card">
            <div style="display:flex; gap:10px; align-items: flex-end;">
                <div style="flex:2"><span class="label-sm">ÈÅ∏ÂèñË∑ëÈÅì</span><select id="tab2Rwy" onchange="refreshTab2()"></select></div>
                <div style="flex:1"><span class="label-sm">Á©∫ÈÄü TAS</span><input type="number" id="tasInput" class="tas-input" value="90" oninput="refreshTab2()"></div>
            </div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button id="bL" style="flex:1; padding:10px; border-radius:5px; border:none; cursor:pointer;" onclick="setSide('L')">LEFT Traffic</button>
                <button id="bR" style="flex:1; padding:10px; border-radius:5px; border:none; cursor:pointer;" onclick="setSide('R')">RIGHT Traffic</button>
            </div>
        </div>
        <div class="card" style="text-align:center">
            <div class="compass-wrap">
                <svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg>
                <div id="rwyBar" class="rwy-bar"><span id="n1" class="rwy-num">--</span><span id="n2" class="rwy-num">--</span></div>
                <div id="windPtr" class="wind-ptr"><svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;"><path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" /></svg></div>
            </div>
        </div>
        <div class="card" style="padding:10px"><span class="label-sm">Ëà™Á∑ö‰øÆÊ≠£ WCA & GS</span><table style="width:100%; font-size: 0.9rem; border-collapse: collapse; text-align: center;"><tbody id="wcaList"></tbody></table></div>
        <div class="card">
            <span class="label-sm">Â∞éËà™È†ªÁéá</span>
            <table class="nav-table"><tbody id="navDataTable"></tbody></table>
        </div>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// „ÄêÊ†∏ÂøÉÔºöÊÅ¢Âæ©ÂéüÂßãÊ©üÂ†¥Ê∏ÖÂñÆ‰∏¶ÂÆöÁæ©Ê≠£Á¢∫Ë∑ëÈÅì„Äë
const airportDB = {
    "RCTP": { name: "Ê°ÉÂúí Taoyuan", lat: 25.0797, lon: 121.2342, runways: ["05L", "05R", "23L", "23R"] },
    "RCSS": { name: "ÊùæÂ±± Songshan", lat: 25.0697, lon: 121.5525, runways: ["10", "28"] },
    "RCKH": { name: "È´òÈõÑ Kaohsiung", lat: 22.5771, lon: 120.3500, runways: ["09", "27"] },
    "RCMQ": { name: "Âè∞‰∏≠ Taichung", lat: 24.2582, lon: 120.6203, runways: ["18", "36"] },
    "RCNN": { name: "Âè∞Âçó Tainan", lat: 22.9507, lon: 120.2058, runways: ["18L", "18R", "36L", "36R"] },
    "RCBS": { name: "ÈáëÈñÄ Kinmen", lat: 24.4297, lon: 118.3586, runways: ["06", "24"] },
    "RCQC": { name: "ÊæéÊπñ Penghu", lat: 23.5681, lon: 119.6281, runways: ["02", "20"] },
    "RCMT": { name: "ÂåóÁ´ø Beigan", lat: 26.2239, lon: 120.0039, runways: ["13", "31"] },
    "RCPO": { name: "Êñ∞Á´π Hsinchu", lat: 24.8186, lon: 120.9389, runways: ["05", "23"] },
    "VHHH": { name: "È¶ôÊ∏Ø Hong Kong", lat: 22.3089, lon: 113.9145, runways: ["07L", "07R", "25L", "25R"] },
    "VMMC": { name: "Êæ≥ÈñÄ Macau", lat: 22.1495, lon: 113.5915, runways: ["16", "34"] },
    "WSSS": { name: "Êñ∞Âä†Âù° Singapore", lat: 1.3644, lon: 103.9915, runways: ["02L", "02C", "02R", "20L", "20C", "20R"] },
    "RKSI": { name: "È¶ñÁàæ‰ªÅÂ∑ù Incheon", lat: 37.4602, lon: 126.4407, runways: ["15L", "15R", "16L", "16R", "33L", "33R", "34L", "34R"] },
    "RJTT": { name: "Êù±‰∫¨ÁæΩÁî∞ Haneda", lat: 35.5494, lon: 139.7798, runways: ["04", "05", "16L", "16R", "22", "23", "34L", "34R"] },
    "KJFK": { name: "Á¥êÁ¥Ñ JFK", lat: 40.6413, lon: -73.7781, runways: ["04L", "04R", "13L", "13R", "22L", "22R", "31L", "31R"] },
    "KLAX": { name: "Ê¥õÊùâÁ£Ø L.A.", lat: 33.9416, lon: -118.4085, runways: ["06L", "06R", "07L", "07R", "24L", "24R", "25L", "25R"] }
};

const groups = [
    { label: "üáπüáº Âè∞ÁÅ£ Taiwan", ids: ["RCTP", "RCSS", "RCKH", "RCMQ", "RCNN", "RCBS", "RCQC", "RCMT", "RCPO"] },
    { label: "üåè ‰∫ûÂ§™ Asia-Pacific", ids: ["VHHH", "VMMC", "WSSS", "RKSI", "RJTT"] },
    { label: "üá∫üá∏ Ê≠êÁæé Global", ids: ["KJFK", "KLAX"] }
];

let jsonNavCache = {}, currentData = null, trafficSide = 'L', map, marker;

function mhzToTacan(mhz) {
    const f = parseFloat(mhz); if (isNaN(f)) return "";
    let ch = (f >= 108.0 && f <= 111.95) ? Math.round((f - 106.3) * 10) + "X" : (f >= 112.3 && f <= 117.95) ? Math.round((f - 105.3) * 10) + "X" : "";
    return ch ? `(${ch})` : "";
}

async function loadDatabases() {
    try {
        const res = await fetch('database.json');
        if (res.ok) { (await res.json()).forEach(apt => { jsonNavCache[apt.code.toUpperCase()] = apt; }); }
    } catch (e) { console.warn("database.json ËºâÂÖ•Â§±Êïó"); }
}

function update() {
    const id = document.getElementById('icaoInput').value.toUpperCase(); if (!id) return;
    const ap = airportDB[id] || { name: id, lat: 25.07, lon: 121.23, runways: ["18", "36"] };
    
    // „ÄêÂêåÊ≠•‰∏ãÊãâÈÅ∏ÂñÆÂêçÁ®±„Äë
    const sel = document.getElementById('apSelect');
    if (sel.value !== id) {
        let found = false;
        for (let opt of sel.options) { if (opt.value === id) { sel.value = id; found = true; break; } }
        if (!found) { sel.add(new Option(`${id} - ${ap.name}`, id), 0); sel.value = id; }
    }

    document.getElementById('rawView').innerText = `Ê≠£Âú®Êü•Ë©¢ ${id}...`;
    fetch(`https://metar.vatsim.net/metar.php?id=${id}&t=${Date.now()}`)
    .then(r => r.text())
    .then(raw => {
        raw = raw.trim();
        let dir = 0, spd = 0, qnh = "N/A", vis = "N/A", rmk = "ÊèêÁ§∫ÔºöÊü•ÁÑ°Ë≥áÊñôÔºåÂ∑≤ËºâÂÖ•È†êË®≠ÂÄº„ÄÇ";
        if (raw && !raw.includes("No METAR")) {
            document.getElementById('rawView').innerText = raw;
            const wMatch = raw.match(/(VRB|\d{3})(\d{2,3})(G\d{2,3})?KT/);
            if (wMatch) { dir = wMatch[1]==="VRB"?0:parseInt(wMatch[1]); spd = parseInt(wMatch[2]); }
            const qMatch = raw.match(/[QA](\d{4})/); qnh = qMatch ? qMatch[0] : "N/A";
            if (raw.includes("CAVOK")) { vis = "10km+ (CAVOK)"; }
            else { const visMatch = raw.match(/\b\d{4}\b/); vis = visMatch ? (visMatch[0]==="9999"?"10km+":visMatch[0]+"m") : "N/A"; }
            rmk = "Ëß£Ë≠ØÂÆåÊàê„ÄÇ";
        }
        document.getElementById('visVal').innerText = vis;
        document.getElementById('qnhVal').innerText = qnh;
        document.getElementById('rmkBox').innerText = rmk;

        let best = "--", minD = 180;
        const aptJson = jsonNavCache[id];
        const rwyList = (aptJson && aptJson.runways) ? aptJson.runways : (ap.runways || ["18", "36"]);
        rwyList.forEach(r => {
            const ils = (aptJson && aptJson.ils_data) ? (aptJson.ils_data[r] || aptJson.ils_data[r.replace(/\D/g,"")]) : null;
            const hdg = ils ? parseInt(ils.crs) : parseInt(r)*10;
            let diff = Math.abs(dir - hdg); if(diff > 180) diff = 360 - diff;
            if(diff < minD) { minD = diff; best = r; }
        });
        currentData = { id, dir, spd, best };
        map.setView([ap.lat, ap.lon], 14);
        marker.setLatLng([ap.lat, ap.lon]);
    })
    .catch(() => { document.getElementById('rawView').innerText = "ÈÄ£Á∑öÂ§±Êïó„ÄÇ"; });
}

function refreshTab2() {
    if(!currentData) return; 
    const r = document.getElementById('tab2Rwy').value, id = currentData.id;
    const tas = parseInt(document.getElementById('tasInput').value) || 90;
    const aptJson = jsonNavCache[id];
    let ils = null, magH = parseInt(r)*10;
    if (aptJson && aptJson.ils_data) {
        ils = aptJson.ils_data[r] || aptJson.ils_data[r.replace(/\D/g,"")];
        if (ils) magH = parseInt(ils.crs);
    }
    const barRot = magH - 90; 
    document.getElementById('rwyBar').style.transform = `translate(-50%, -50%) rotate(${barRot}deg)`;
    const n1 = document.getElementById('n1'), n2 = document.getElementById('n2');
    n1.innerText = r; n2.innerText = (parseInt(r)>18 ? (parseInt(r)-18).toString().padStart(2,'0') : (parseInt(r)+18).toString().padStart(2,'0'));
    n1.style.transform = `rotate(${-barRot}deg)`; n2.style.transform = `rotate(${-barRot}deg)`;
    document.getElementById('windPtr').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;
    
    const legs = [{n:"Upwind", t:magH}, {n:"Cross", t:(magH+(trafficSide==='L'?-90:90)+360)%360}, {n:"Downwind", t:(magH+180)%360}, {n:"Base", t:(magH+(trafficSide==='L'?90:-90)+360)%360}];
    let h = ""; legs.forEach(l => {
        const a = (currentData.dir - l.t) * Math.PI / 180;
        let wRad = Math.asin((currentData.spd * Math.sin(a)) / tas); if(isNaN(wRad)) wRad = 0;
        const gs = Math.round(tas * Math.cos(wRad) + currentData.spd * Math.cos(a));
        h += `<tr><td align="left"><b>${l.n}</b></td><td>${Math.round(l.t)}¬∞</td><td><b>${(Math.round(l.t)+Math.round(wRad*180/Math.PI)+360)%360}¬∞</b></td><td align="right" style="color:var(--accent)">${gs}KT</td></tr>`;
    }); 
    document.getElementById('wcaList').innerHTML = h;
    let nav = `<tr><td style="color:var(--dim)">ILS</td><td style="color:var(--accent); font-weight:bold">${ils?ils.ident:'N/A'}</td><td align="right" style="color:var(--accent); font-weight:bold">${ils?ils.freq+' '+mhzToTacan(ils.freq):'N/A'}</td></tr>`;
    nav += `<tr><td style="color:var(--dim)">CRS</td><td colspan="2" align="right" style="color:var(--accent); font-weight:bold">${magH}¬∞</td></tr>`;
    document.getElementById('navDataTable').innerHTML = nav;
}

function transfer() {
    if(!currentData) return; const s = document.getElementById('tab2Rwy'); s.innerHTML = "";
    const aptJson = jsonNavCache[currentData.id];
    const rwyList = (aptJson && aptJson.runways) ? aptJson.runways : (airportDB[currentData.id]?.runways || ["18", "36"]);
    rwyList.forEach(r => {
        let o = new Option("RWY " + r, r); if(r === currentData.best) o.selected = true; s.add(o);
    });
    refreshTab2(); switchTab(2);
}

function setSide(s) { 
    trafficSide = s; 
    document.getElementById('bL').style.background = s === 'L' ? 'var(--accent)' : '#334155'; 
    document.getElementById('bL').style.color = s === 'L' ? '#000' : '#fff'; 
    document.getElementById('bR').style.background = s === 'R' ? 'var(--accent)' : '#334155'; 
    document.getElementById('bR').style.color = s === 'R' ? '#000' : '#fff';
    refreshTab2();
}

function switchTab(n) { document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + n).classList.add('active'); document.querySelectorAll('.tab-btn')[n-1].classList.add('active'); }
function manualUpdate() { update(); }

function init() {
    loadDatabases();
    const sel = document.getElementById('apSelect');
    groups.forEach(g => {
        let grp = document.createElement('optgroup'); grp.label = g.label;
        g.ids.forEach(id => { if(airportDB[id]) grp.appendChild(new Option(`${id} - ${airportDB[id].name}`, id)); });
        sel.appendChild(grp);
    });
    sel.value = "RCSS"; document.getElementById('icaoInput').value = "RCSS";
    map = L.map('map', { zoomControl: false }).setView([25.06, 121.55], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([25.06, 121.55]).addTo(map);
    const svg = document.getElementById('compSvg'), lbls = { 0:'N', 90:'E', 180:'S', 270:'W' };
    let ticks = ''; for(let i=0; i<360; i+=10) {
        let isL = i % 30 === 0, x1 = 100 + Math.sin(i*Math.PI/180)*(isL?82:88), y1 = 100 - Math.cos(i*Math.PI/180)*(isL?82:88);
        ticks += `<line x1="${x1}" y1="${y1}" x2="${100+Math.sin(i*Math.PI/180)*96}" y2="${100-Math.cos(i*Math.PI/180)*96}" stroke="#94a3b8" stroke-width="${isL?2:1}" />`;
        if(i % 90 === 0) ticks += `<text x="${100+Math.sin(i*Math.PI/180)*72}" y="${100-Math.cos(i*Math.PI/180)*72}" fill="white" font-size="14" font-weight="bold" text-anchor="middle">${lbls[i]}</text>`;
    } svg.innerHTML = ticks;
    update(); setSide('L');
}
window.onload = init;
</script>
</body>
</html>
