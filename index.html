<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Pocket METAR Pro - Instructor Edition v2.8</title>
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
Â  Â  <style>
Â  Â  Â  Â  :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --dim: #94a3b8; --green: #4ade80; --red: #fb7185; --warn: #facc15; }
Â  Â  Â  Â  body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
Â  Â  Â  Â  .container { max-width: 650px; margin: 0 auto; }
Â  Â  Â  Â  .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
Â  Â  Â  Â  .tab-btn { flex: 1; padding: 14px; background: #334155; border: none; color: white; border-radius: 8px 8px 0 0; cursor: pointer; opacity: 0.6; font-weight: bold; }
Â  Â  Â  Â  .tab-btn.active { background: var(--card); border-bottom: 3px solid var(--accent); opacity: 1; }
Â  Â  Â  Â  .tab-content { display: none; }
Â  Â  Â  Â  .tab-content.active { display: block; }
Â  Â  Â  Â  .card { background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
Â  Â  Â  Â  .label-sm { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; display: block; }
Â  Â  Â  Â  .rwy-id { font-size: 3.5rem; font-weight: 900; line-height: 1; letter-spacing: -2px; }
Â  Â  Â  Â  .raw-text { font-family: 'Consolas', monospace; color: var(--green); font-size: 0.85rem; line-height: 1.4; background: #000; padding: 10px; border-radius: 6px; border-left: 4px solid var(--green); margin-top: 8px; white-space: pre-wrap; word-break: break-all; }
Â  Â  Â  Â  .compass-wrap { position: relative; width: 260px; height: 260px; margin: 15px auto; border-radius: 50%; background: #1a365d; border: 2px solid #334155; }
Â  Â  Â  Â  .rwy-bar { position: absolute; top: 50%; left: 50%; width: 160px; height: 20px; background: #111; border: 1.5px solid #fff; transform: translate(-50%, -50%); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-radius: 3px; }
Â  Â  Â  Â  .rwy-num { display: inline-block; color: white; font-size: 11px; font-weight: bold; font-family: monospace; }
Â  Â  Â  Â  .wind-ptr { position: absolute; top: 50%; left: 50%; width: 0; height: 0; transform-origin: center center; z-index: 20; transition: transform 0.8s ease; }
Â  Â  Â  Â  #map { height: 260px; border-radius: 12px; margin-top: 10px; background: #111; border: 1px solid #444; }
Â  Â  Â  Â  .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
Â  Â  Â  Â  .input-group input { flex: 1; padding: 12px; background: #334155; color: white; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
Â  Â  Â  Â  .input-group button { padding: 0 20px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
Â  Â  Â  Â  select, .tas-input { width: 100%; padding: 14px; background: #334155; color: white; border: none; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
Â  Â  Â  Â  .nav-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
Â  Â  Â  Â  .nav-table td { padding: 10px 5px; border-bottom: 1px solid #334151; }
Â  Â  Â  Â  .nav-table .val { color: var(--accent); font-weight: bold; font-family: 'Consolas', monospace; }
Â  Â  Â  Â  .cloud-item { display: flex; justify-content: space-between; background: rgba(56, 189, 248, 0.1); padding: 8px 12px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 4px; }
Â  Â  Â  Â  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
Â  Â  Â  Â  .info-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border-left: 3px solid #475569; }
Â  Â  Â  Â  .warn-text { color: var(--red) !important; animation: blink 1s infinite; }
Â  Â  Â  Â  @keyframes blink { 50% { opacity: 0.5; } }
Â  Â  </style>
</head>
<body>

<div class="container">
Â  Â  <div class="tabs">
Â  Â  Â  Â  <button class="tab-btn active" onclick="switchTab(1)">æ©Ÿå ´è³‡è¨Š</button>
Â  Â  Â  Â  <button class="tab-btn" onclick="switchTab(2)">èˆªç·šè¨ˆç®—</button>
Â  Â  </div>

Â  Â  <div id="tab1" class="tab-content active">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <span class="label-sm">ICAO æ‰‹å‹•è¼¸å…¥ / é¸å–</span>
Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="icaoInput" placeholder="ä¾‹å¦‚: RCTP" maxlength="4">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="manualUpdate()">æŸ¥è©¢</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <select id="apSelect" onchange="document.getElementById('icaoInput').value=this.value; update()"></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card"><span class="label-sm">åŸå§‹é›»ç¢¼ RAW DATA</span><div id="rawView" class="raw-text">æ•¸æ“šåº«è¼‰å…¥ä¸­...</div></div>
Â  Â  Â  Â  <div id="map"></div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <span class="label-sm">é‡é»è§£è­¯ DECODER</span>
Â  Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="label-sm" style="margin:0">èƒ½è¦‹åº¦ VIS</span><div id="visVal" style="font-weight:bold; font-size:1.1rem">--</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><span class="label-sm" style="margin:0">æ°£å£“ QNH</span><div id="qnhVal" style="font-weight:bold; font-size:1.1rem">--</div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="cloudBox" style="margin-top:8px"></div>
Â  Â  Â  Â  Â  Â  <div id="rmkBox" style="margin-top:10px; font-size:0.85rem; color:var(--accent); white-space: pre-line;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button onclick="transfer()" style="width:100%; padding:18px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin: 10px 0 30px 0;">å‚³é€è‡³è¨ˆç®—é é¢ â”</button>
Â  Â  </div>

Â  Â  <div id="tab2" class="tab-content">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; align-items: flex-end;">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:2"><span class="label-sm">é¸å–è·‘é“</span><select id="tab2Rwy" onchange="refreshTab2()"></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1"><span class="label-sm">ç©ºé€Ÿ TAS</span><input type="number" id="tasInput" class="tas-input" value="90" oninput="refreshTab2()"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:5px; margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="bL" style="flex:1; padding:10px; border-radius:5px; border:none; cursor:pointer;" onclick="setSide('L')">LEFT Traffic</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="bR" style="flex:1; padding:10px; border-radius:5px; border:none; cursor:pointer;" onclick="setSide('R')">RIGHT Traffic</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card" style="text-align:center">
Â  Â  Â  Â  Â  Â  <div class="compass-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="260" height="260" viewBox="0 0 200 200" id="compSvg"></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rwyBar" class="rwy-bar"><span id="n1" class="rwy-num">--</span><span id="n2" class="rwy-num">--</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="windPtr" class="wind-ptr"><svg width="24" height="30" viewBox="0 0 24 30" style="position:absolute; top:-125px; left:-12px;"><path d="M12 30 L24 5 L12 12 L0 5 Z" fill="white" /></svg></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card" style="padding:10px">
Â  Â  Â  Â  Â  Â  <span class="label-sm">èˆªç·šä¿®æ­£ WCA & GS</span>
Â  Â  Â  Â  Â  Â  <table style="width:100%; font-size: 0.9rem; border-collapse: collapse; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="wcaList"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card"><span class="label-sm">å°èˆªè³‡æ–™ NAV (ILS/TACAN)</span><table class="nav-table"><tbody id="navDataTable"></tbody></table></div>
Â  Â  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const airportDB = {
Â  Â  "RCTP": { name: "æ¡ƒåœ’ Taoyuan", lat: 25.0797, lon: 121.2342, rwys: { "05L": {mag:52, true:48.8}, "05R": {mag:52, true:48.8}, "23L": {mag:232, true:228.8}, "23R": {mag:232, true:228.8} } },
Â  Â  "RCSS": { name: "æ¾å±± Songshan", lat: 25.0697, lon: 121.5525, rwys: { "10": {mag:100, true:93.5}, "28": {mag:280, true:273.5} } },
Â  Â  "RCKH": { name: "é«˜é›„ Kaohsiung", lat: 22.5771, lon: 120.3500, rwys: { "09": {mag:87, true:84.2}, "27": {mag:267, true:264.2} } },
Â  Â  "RCMQ": { name: "å°ä¸­ Taichung", lat: 24.2582, lon: 120.6203, rwys: { "18": {mag:180, true:175}, "36": {mag:360, true:355} } },
Â  Â  "RCNN": { name: "å°å— Tainan", lat: 22.9507, lon: 120.2058, rwys: { "18R": {mag:180, true:176.5}, "36L": {mag:360, true:356.5} } },
Â  Â  "RCBS": { name: "é‡‘é–€ Kinmen", lat: 24.4297, lon: 118.3586, rwys: { "06": {mag:60, true:55}, "24": {mag:240, true:235} } },
Â  Â  "RCQC": { name: "æ¾æ¹– Penghu", lat: 23.5681, lon: 119.6281, rwys: { "02": {mag:20, true:16.5}, "20": {mag:200, true:196.5} } },
Â  Â  "VHHH": { name: "é¦™æ¸¯ Hong Kong", lat: 22.3089, lon: 113.9145, rwys: { "07L": {mag:73, true:71}, "25R": {mag:253, true:251} } },
Â  Â  "VMMC": { name: "æ¾³é–€ Macau", lat: 22.1495, lon: 113.5915, rwys: { "16": {mag:160, true:158}, "34": {mag:340, true:338} } },
Â  Â  "WSSS": { name: "æ–°åŠ å¡ Singapore", lat: 1.3644, lon: 103.9915, rwys: { "02L": {mag:20, true:20}, "20R": {mag:200, true:200} } },
Â  Â  "RKSI": { name: "é¦–çˆ¾ä»å· Incheon", lat: 37.4602, lon: 126.4407, rwys: { "15R": {mag:153, true:145}, "33L": {mag:333, true:325} } },
Â  Â  "RJTT": { name: "æ±äº¬ç¾½ç”° Haneda", lat: 35.5494, lon: 139.7798, rwys: { "34L": {mag:337, true:330}, "34R": {mag:337, true:330}, "16L": {mag:157, true:150}, "16R": {mag:157, true:150} } },
Â  Â  "KJFK": { name: "ç´ç´„ JFK", lat: 40.6413, lon: -73.7781, rwys: { "04L": {mag:44, true:57}, "22R": {mag:224, true:237} } },
Â  Â  "KLAX": { name: "æ´›æ‰ç£¯ L.A.", lat: 33.9416, lon: -118.4085, rwys: { "24L": {mag:251, true:263}, "25R": {mag:251, true:263} } }
};

const groups = [
Â  Â  { label: "ğŸ‡¹ğŸ‡¼ å°ç£ Taiwan", ids: ["RCTP", "RCSS", "RCKH", "RCMQ", "RCNN", "RCBS", "RCQC"] },
Â  Â  { label: "ğŸŒ äºå¤ª Asia-Pacific", ids: ["VHHH", "VMMC", "WSSS", "RKSI", "RJTT"] },
Â  Â  { label: "ğŸ‡ºğŸ‡¸ æ­ç¾ Global", ids: ["KJFK", "KLAX"] }
];

let navDataDB = {}, currentData = null, trafficSide = 'L', map, marker, patternOverlay;

// 1. å¼·åŒ–å‹ MHz è½‰ TACAN Channel
function mhzToTacan(mhz) {
Â  Â  const f = parseFloat(mhz); if (isNaN(f)) return "";
Â  Â  let ch = "";
Â  Â  if (f >= 108.00 && f <= 111.95) ch = Math.round((f - 106.3) * 10) + "X";
Â  Â  else if (f >= 112.30 && f <= 117.95) ch = Math.round((f - 105.3) * 10) + "X";
Â  Â  return ch ? `(${ch})` : "";
}

// 2. Decoder é‚è¼¯
const decodeMetarLogic = (raw) => {
Â  Â  let d = [];
Â  Â  if(raw.includes("NOSIG")) d.push("â€¢ NOSIG (å¤©æ°£ç©©å®š)");
Â  Â  if(raw.includes("CAVOK")) d.push("â€¢ CAVOK (èƒ½è¦‹/é›²æ³è‰¯å¥½)");
Â  Â  if(raw.includes("TS")) d.push("â€¢ TS (é›·æš´é¢¨éšª)");
Â  Â  if(raw.includes("WS")) d.push("â€¢ WS (é¢¨åˆ‡é è­¦)");
Â  Â  if(raw.includes("RA")) d.push("â€¢ RA (é™é›¨)");
Â  Â  if(raw.includes("FG") || raw.includes("BR")) d.push("â€¢ FG/BR (ä½èƒ½è¦‹åº¦)");
Â  Â  return d.length > 0 ? d.join('\n') : "ç„¡é¡¯è‘—å¤©æ°£ç¾è±¡";
};

// 3. æ•¸æ“šåº«ç´¢å¼•ä¿®æ­£èˆ‡è®€å–
async function ingestOurAirportsData() {
    try {
        const [rRes, nRes] = await Promise.all([fetch('runways.csv'), fetch('navaids.csv')]);
        const rText = await rRes.text(), nText = await nRes.text();
        const navMap = {}; 

        // è®€å– Navaids
        nText.split('\n').slice(1).forEach(line => {
            const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (c.length < 20) return;
            const ident = c[2].replace(/"/g,''), type = c[4], freqRaw = parseFloat(c[5]), icao = c[19].toUpperCase().replace(/"/g,'').trim();
            const freq = (freqRaw > 500) ? (freqRaw / 1000).toFixed(2) : freqRaw.toFixed(2);
            if (!navMap[icao]) navMap[icao] = [];
            navMap[icao].push({ ident, type, freq, name: c[3] });
        });

        // è®€å– Runways ä¸¦é…å°
        rText.split('\n').slice(1).forEach(line => {
            const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (c.length < 19) return;
            const icao = c[2].replace(/"/g,'').toUpperCase().trim();
            if (!navDataDB[icao]) navDataDB[icao] = {};

            // é‡å°è·‘é“å…©ç«¯åˆ†åˆ¥è™•ç†
            [ {id: c[8], hdg: c[12]}, {id: c[14], hdg: c[18]} ].forEach(end => {
                const rId = end.id.replace(/"/g,'').trim(); if (!rId) return;
                const airportNavs = navMap[icao] || [];
                const crs = end.hdg ? Math.round(parseFloat(end.hdg.replace(/"/g,''))).toString().padStart(3,'0') : rId.padStart(2,'0')+"0";

                // 1. æ‰¾ VOR (å…¨æ©Ÿå ´é€šç”¨ï¼Œå„ªå…ˆæ‰¾ VORTAC æˆ– VOR-DME)
                let vorMatch = airportNavs.find(n => n.type === 'VORTAC') || 
                               airportNavs.find(n => n.type === 'VOR-DME') || 
                               airportNavs.find(n => n.type === 'VOR');

                // 2. æ‰¾ ILS (è·‘é“å°ˆç”¨ï¼Œåç¨±é€šå¸¸åŒ…å«è·‘é“è™Ÿç¢¼ï¼Œå¦‚ "05L")
                // OurAirports çš„ name æ¬„ä½é€šå¸¸æ˜¯ "Taoyuan Int Airport ILS 05L"
                let ilsMatch = airportNavs.find(n => 
                    (n.type.includes('ILS') || n.type.includes('LOC')) && 
                    (n.name.includes(` ${rId}`) || n.ident.includes(rId.replace(/\D/g,'')))
                );

                // å­˜å…¥é›™é‡è³‡æ–™
                navDataDB[icao][rId] = {
                    vor: vorMatch ? { ...vorMatch, crs: crs } : null,
                    ils: ilsMatch ? { ...ilsMatch, crs: crs } : null
                };
            });
        });
        document.getElementById('rawView').innerText = "æ•¸æ“šåº« (VOR/ILS) å·²å°±ç·’ã€‚";
    } catch (e) { document.getElementById('rawView').innerText = "åŠ è¼‰éŒ¯èª¤"; }
}

function update() {
Â  Â  const id = document.getElementById('icaoInput').value.toUpperCase(); if (!id) return;
Â  Â  const ap = airportDB[id] || { name: id, lat: 25.07, lon: 121.23, rwys: {} };
Â  Â  fetch(`https://metar.vatsim.net/metar.php?id=${id}&t=${Date.now()}`).then(r => r.text()).then(raw => {
Â  Â  Â  Â  document.getElementById('rawView').innerText = raw.trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // é¢¨å‘
Â  Â  Â  Â  const wMatch = raw.match(/(VRB|\d{3})(\d{2,3})(G\d{2,3})?KT/);
Â  Â  Â  Â  let dir = 0, spd = 0; if (wMatch) { dir = wMatch[1]==="VRB"?0:parseInt(wMatch[1]); spd = parseInt(wMatch[2]); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CAVOK å„ªå…ˆè™•ç†
Â  Â  Â  Â  if (raw.includes("CAVOK")) {
Â  Â  Â  Â  Â  Â  document.getElementById('visVal').innerText = "10km+ (CAVOK)";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const visMatch = raw.match(/\b\d{4}\b/);
Â  Â  Â  Â  Â  Â  document.getElementById('visVal').innerText = visMatch ? (visMatch[0]==="9999"?"10km+":visMatch[0]+"m") : "N/A";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const qMatch = raw.match(/Q(\d{4})/);
Â  Â  Â  Â  const aMatch = raw.match(/A(\d{4})/);
Â  Â  Â  Â  document.getElementById('qnhVal').innerText = qMatch ? qMatch[1]+" hPa" : (aMatch ? (parseInt(aMatch[1])/100).toFixed(2)+" inHg" : "--");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const cloudRegex = /(FEW|SCT|BKN|OVC|VV)(\d{3})/g;
Â  Â  Â  Â  let cMatch, cloudsHtml = "";
Â  Â  Â  Â  while ((cMatch = cloudRegex.exec(raw)) !== null) {
Â  Â  Â  Â  Â  Â  cloudsHtml += `<div class="cloud-item"><span><b>${cMatch[1]}</b></span><span>${parseInt(cMatch[2])*100} ft</span></div>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('cloudBox').innerHTML = cloudsHtml || "Sky Clear / NSC";
Â  Â  Â  Â  document.getElementById('rmkBox').innerText = decodeMetarLogic(raw);

Â  Â  Â  Â  let best = "--", minD = 180;
Â  Â  Â  Â  for(let r in ap.rwys) { let diff = Math.abs(dir-ap.rwys[r].mag); if(diff>180) diff=360-diff; if(diff<minD){minD=diff; best=r;} }
Â  Â  Â  Â  currentData = { id, dir, spd, best };
Â  Â  Â  Â  map.setView([ap.lat, ap.lon], 14); marker.setLatLng([ap.lat, ap.lon]);
Â  Â  Â  Â  if(best !== "--") drawMapPattern(id, best);
Â  Â  });
}

function refreshTab2() {
    if(!currentData) return; 
    const r = document.getElementById('tab2Rwy').value, ap = airportDB[currentData.id];
    const tas = parseInt(document.getElementById('tasInput').value) || 90;
    const magH = (ap && ap.rwys[r]) ? ap.rwys[r].mag : parseInt(r)*10;
    
    // -- ç¾…ç›¤èˆ‡ WCA è¨ˆç®—éƒ¨åˆ†ä¿æŒä¸è®Š --
    document.getElementById('rwyBar').style.transform = `translate(-50%, -50%) rotate(${magH-90}deg)`;
    document.getElementById('n1').innerText = r; document.getElementById('n2').innerText = (parseInt(r)>18?parseInt(r)-18:parseInt(r)+18).toString().padStart(2,'0');
    document.getElementById('windPtr').style.transform = `translate(-50%, -50%) rotate(${currentData.dir}deg)`;
    
    const legs = [{n:"Upwind", t:magH}, {n:"Cross", t:(magH+(trafficSide==='L'?-90:90)+360)%360}, {n:"Downwind", t:(magH+180)%360}, {n:"Base", t:(magH+(trafficSide==='L'?90:-90)+360)%360}];
    let h = ""; legs.forEach(l => {
        const a = (currentData.dir - l.t) * Math.PI / 180;
        let wRad = Math.asin((currentData.spd * Math.sin(a)) / tas); if(isNaN(wRad)) wRad = 0;
        const wDeg = Math.round(wRad * 180 / Math.PI);
        const gs = Math.round(tas * Math.cos(wRad) + currentData.spd * Math.cos(a));
        h += `<tr><td align="left"><b>${l.n}</b></td><td>${Math.round(l.t)}Â°</td><td>${wDeg>=0?'+':''}${wDeg}Â°</td><td><b>${((Math.round(l.t)+wDeg+360)%360).toString().padStart(3,'0')}Â°</b></td><td align="right" style="color:var(--accent)">${gs}KT</td></tr>`;
    }); 
    document.getElementById('wcaList').innerHTML = h;

    // -- æ–°çš„ NAV è³‡æ–™é¡¯ç¤ºéƒ¨åˆ† --
    const nav = (navDataDB[currentData.id] && navDataDB[currentData.id][r]) ? navDataDB[currentData.id][r] : { vor: null, ils: null };
    let navHtml = "";

    // 1. VOR å€å¡Š
    if (nav.vor) {
        navHtml += `
            <tr style="background:rgba(255, 255, 255, 0.05);"><td colspan="2" style="padding:4px 5px; color:#fb923c; font-size:0.8rem;">â— VOR / TACAN</td></tr>
            <tr><td>${nav.vor.ident} (${nav.vor.type})</td><td align="right" class="val">${nav.vor.freq}</td></tr>
            <tr><td style="border-bottom:2px solid #334155">Inbound Crs</td><td align="right" class="val" style="border-bottom:2px solid #334155">${nav.vor.crs}Â°</td></tr>
        `;
    }

    // 2. ILS å€å¡Š
    if (nav.ils) {
        navHtml += `
            <tr style="background:rgba(56, 189, 248, 0.1);"><td colspan="2" style="padding:4px 5px; color:#38bdf8; font-size:0.8rem;">â— ILS APPROACH</td></tr>
            <tr><td>${nav.ils.ident} (${nav.ils.type})</td><td align="right" class="val">${nav.ils.freq}</td></tr>
            <tr><td>LOC Course</td><td align="right" class="val">${nav.ils.crs}Â°</td></tr>
        `;
    }

    if (!nav.vor && !nav.ils) {
        navHtml = `<tr><td colspan="2" align="center" style="padding:20px; color:var(--dim)">ç„¡å°èˆªè³‡æ–™</td></tr>`;
    }

    document.getElementById('navDataTable').innerHTML = navHtml;
}

function transfer() {
Â  Â  if(!currentData) return; const s = document.getElementById('tab2Rwy'); s.innerHTML = "";
Â  Â  const ap = airportDB[currentData.id]; if(ap) { for(let r in ap.rwys) { let o = new Option("RWY "+r, r); if(r===currentData.best) o.selected=true; s.add(o); } }
Â  Â  refreshTab2(); switchTab(2);
}
function setSide(s) { trafficSide = s; document.getElementById('bL').style.background = s === 'L' ? 'var(--accent)' : '#334155'; document.getElementById('bR').style.background = s === 'R' ? 'var(--accent)' : '#334155'; refreshTab2(); }
function switchTab(n) { document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + n).classList.add('active'); document.querySelectorAll('.tab-btn')[n-1].classList.add('active'); if(n === 1) setTimeout(() => map.invalidateSize(), 300); }
function manualUpdate() { update(); }

function drawMapPattern(id, rwy) {
Â  Â  const ap = airportDB[id]; if(!ap || !ap.rwys[rwy]) return;
Â  Â  const s = trafficSide === 'L' ? -1 : 1, tH = ap.rwys[rwy].true;
Â  Â  const latF = 1 / 60, lonF = latF / Math.cos(ap.lat * Math.PI / 180);
Â  Â  const toR = Math.PI / 180, rH = (90 - tH) * toR, rS = (90 - (tH + 90 * s)) * toR;
Â  Â  const m = (p, a, d) => [p[0] + Math.sin(a) * d * latF, p[1] + Math.cos(a) * d * lonF];
Â  Â  const p1 = m([ap.lat, ap.lon], rH, 1.5), p2 = m([ap.lat, ap.lon], rH, -1.5), p3 = m(p2, rS, 1.2), p4 = m(p1, rS, 1.2);
Â  Â  patternOverlay.setLatLngs([p1, p2, p3, p4, p1]);
}

function init() {
Â  Â  ingestOurAirportsData();
Â  Â  const sel = document.getElementById('apSelect');
Â  Â  groups.forEach(g => {
Â  Â  Â  Â  let grp = document.createElement('optgroup'); grp.label = g.label;
Â  Â  Â  Â  g.ids.forEach(id => { if(airportDB[id]) grp.appendChild(new Option(`${id} - ${airportDB[id].name}`, id)); });
Â  Â  Â  Â  sel.appendChild(grp);
Â  Â  });
Â  Â  sel.value = "RCSS"; document.getElementById('icaoInput').value = "RCSS";
Â  Â  map = L.map('map', { zoomControl: false }).setView([25.0697, 121.5525], 13);
Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
Â  Â  marker = L.marker([25.0697, 121.5525]).addTo(map);
Â  Â  patternOverlay = L.polyline([], { color: '#38bdf8', weight: 3, dashArray: '10, 10' }).addTo(map);
Â  Â  const svg = document.getElementById('compSvg'), lbls = { 0:'N', 90:'E', 180:'S', 270:'W' };
Â  Â  let ticks = ''; for(let i=0; i<360; i+=10) {
Â  Â  Â  Â  let isL = i % 30 === 0, x1 = 100 + Math.sin(i*Math.PI/180)*(isL?82:88), y1 = 100 - Math.cos(i*Math.PI/180)*(isL?82:88);
Â  Â  Â  Â  let x2 = 100 + Math.sin(i*Math.PI/180)*96, y2 = 100 - Math.cos(i*Math.PI/180)*96;
Â  Â  Â  Â  ticks += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="${isL?2:1}" />`;
Â  Â  Â  Â  if(i % 90 === 0) ticks += `<text x="${100+Math.sin(i*Math.PI/180)*72}" y="${100-Math.cos(i*Math.PI/180)*72}" fill="white" font-size="14" font-weight="bold" text-anchor="middle">${lbls[i]}</text>`;
Â  Â  } svg.innerHTML = ticks;
Â  Â  setSide('L'); update();
}
window.onload = init;
</script>
</body>
</html>
